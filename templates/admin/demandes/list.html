{% extends "base_admin.html" %}
{% load static %}

{% block page_title %}Demandes{% endblock %}
{% block page_subtitle %}Gérez toutes les demandes de devis et filtrez rapidement (nom, téléphone, email, adresse, statut).{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/demandes_list.css' %}">
{% endblock %}

{% block content %}

<!-- Toolbar -->
<div class="az-toolbar">
  <form method="get" class="az-filters">
    <div class="az-field az-field--wide">
      <span class="az-label">Recherche</span>
      <input
        class="az-control"
        type="text"
        name="q"
        placeholder="Nom / Téléphone / Email / Adresse..."
        value="{{ q|default:'' }}"
      >
    </div>

    <div class="az-field">
      <span class="az-label">Statut</span>
      <select class="az-control" name="statut">
        <option value="">Tous</option>
        {% for value,label in statuts %}
          <option value="{{ value }}" {% if statut == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <button class="a-btn a-btn-primary" type="submit">
      <i class="fas fa-filter"></i> Filtrer
    </button>
    <a class="a-btn a-btn-soft" href="{% url 'demandes:list' %}">
      <i class="fas fa-rotate-left"></i> Reset
    </a>
  </form>

  <a class="a-btn a-btn-primary" href="{% url 'demandes:create' %}">
    <i class="fas fa-plus"></i> Ajouter
  </a>
</div>

<!-- Table card -->
<div class="a-card">
  <div class="a-table-wrap">
    <table class="a-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Client</th>
          <th>Téléphone</th>
          <th>Service</th>
          <th>Statut</th>
          <th>Créée</th>
          <th class="a-th-right">Action</th>
        </tr>
      </thead>

      <tbody id="demandesTbody">
        {% for d in items %}
        <tr class="a-row" data-id="{{ d.id }}"
            data-client="{{ d.nom|default:''|lower }}"
            data-phone="{{ d.telephone|default:''|lower }}"
            data-email="{{ d.email|default:''|lower }}"
            data-adresse="{{ d.adresse|default:''|lower }}"
            data-statut="{{ d.get_statut_display|default:''|lower }}"
            data-service="{{ d.service|default:''|lower }}">
          <td class="a-id">#{{ d.id }}</td>

          <td>
            <div class="a-client">
              <span class="a-client-name">{{ d.nom }}</span>
              <span class="a-client-sub">{{ d.email|default:"-" }}</span>
            </div>
          </td>

          <td>{{ d.telephone }}</td>
          <td>{{ d.service|default:"-" }}</td>

          <td>
            <span class="a-badge a-badge-{{ d.statut|slugify }}">
              {{ d.get_statut_display }}
            </span>
          </td>

          <td class="a-muted-td">{{ d.created_at|date:"Y-m-d H:i" }}</td>

          <td class="a-td-right">
  <div style="
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: flex-end;
  ">

    <!-- Voir -->
    <a href="{% url 'demandes:detail' d.id %}"
       style="
         display: inline-flex;
         align-items: center;
         gap: 6px;
         font-size: 12px;
         font-weight: 600;
         text-decoration: none;
         cursor: pointer;
       ">
      <i class="fas fa-eye"></i>
      Voir
    </a>

    <!-- Supprimer -->
    <form method="post"
          action="{% url 'demandes:delete' d.id %}"
          onsubmit="return confirm('Supprimer définitivement cette demande ?');">

      {% csrf_token %}

      <button type="submit"
              style="
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 12px;
                font-weight: 600;
                background: none;
                border: none;
                padding: 0;
                cursor: pointer;
              ">
        <i class="fas fa-trash"></i>
        Supprimer
      </button>
    </form>

  </div>
</td>

        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="a-empty-td">Aucune demande</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="a-empty" id="emptyState">
    <i class="fas fa-search"></i>
    <h3>Aucun résultat</h3>
    <p>Change la recherche ou les filtres.</p>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'admin/js/demandes_list.js' %}?v=1"></script>

{% endblock %}
